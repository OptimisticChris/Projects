<script>

const lootTable = [
    // Utility / Common Items
    { name: "Torch", desc: "A dimly lit torch.", rarity: 10 },
    { name: "Rusty Key", desc: "Old and worn, might open something.", rarity: 5 },
    { name: "Lantern", desc: "Sturdy light source.", rarity: 6 },
    { name: "Silver Coin", desc: "Shiny currency.", rarity: 8 },
    { name: "Compass", desc: "Always points north.", rarity: 4 },

    // ðŸŽ Food & Drink (common, stackable)
    { name: "Chocolate", desc: "OOooOO Piece of candy!", effects: { hp: 5, stamina: 5 }, stackable: true, rarity: 15 },
    { name: "Apple", desc: "A crisp red apple.", effects: { hp: 6, stamina: 6 }, stackable: true, rarity: 15 },
    { name: "Sandwich", desc: "A delicious snack.", effects: { hp: 8, stamina: 8 }, stackable: true, rarity: 12 },
    { name: "Bottle of Water", desc: "Fresh and clean.", effects: { hp: 5, stamina: 7 }, stackable: true, rarity: 12 },
    { name: "Bread", desc: "Freshly baked.", effects: { hp: 7, stamina: 6 }, stackable: true, rarity: 12 },
    { name: "Cheese", desc: "Aged and aromatic.", effects: { hp: 7, stamina: 7 }, stackable: true, rarity: 10 },
    { name: "Wine", desc: "A bottle of red.", effects: { hp: 6, stamina: 8 }, stackable: true, rarity: 8 },
    { name: "Carrot", desc: "Crunchy and healthy.", effects: { hp: 5, stamina: 5 }, stackable: true, rarity: 14 },
    { name: "Beef Jerky", desc: "Salty dried meat.", effects: { hp: 9, stamina: 9 }, stackable: true, rarity: 10 },

    // âš”ï¸ Weapons (uncommon/rare, unique)
    { name: "Fists", weapon: true, damage: 5, rarity: 1},
    { name: "Dagger", weapon: true, damage: 7, rarity: 6 },
    { name: "Iron Sword", weapon: true, damage: 12, rarity: 4 },
    { name: "Wooden Shield", weapon: true, damage: 10, rarity: 5 },
    { name: "Crossbow", weapon: true, damage: 16, rarity: 3 },
    { name: "Crystal Dagger", weapon: true, damage: 18, rarity: 2 },

    // ðŸ”® Rare Artifacts (very rare, unique)
    { name: "Crystal Pendant", desc: "Glows faintly.", effects: { affinity: +5 }, rarity: 2 },
    { name: "Magic Ring", desc: "Enhances the wearer.", effects: { affinity: +8 }, rarity: 2 },
    { name: "Dragon Scale", desc: "Radiates heat.", effects: { affinity: +10 }, rarity: 1 },
    { name: "Phoenix Feather", desc: "Said to contain rebirth magic.", effects: { affinity: +12 }, rarity: 1 },
    { name: "Crystal Ball", desc: "Shows visions.", effects: { affinity: -8 }, rarity: 1 },
    { name: "Obsidian Shard", desc: "Dark and sharp.", effects: { affinity: -5 }, rarity: 2 },
    { name: "Spirit Stone", desc: "Whispers faint voices.", effects: { affinity: -10 }, rarity: 1 },
    { name: "Mystic Tome", desc: "Overflowing with knowledge.", effects: { affinity: +15 }, rarity: 1 },
    { name: "Lucky Coin", desc: "Always lands heads.", effects: { affinity: +3 }, rarity: 3 },
];



function weightedRandomPick(table) {
    const totalWeight = table.reduce((sum, item) => sum + (item.rarity || 1), 0);
    let roll = Math.random() * totalWeight;

    for (let item of table) {
        roll -= item.rarity || 1;
        if (roll <= 0) {
            return item;
        }
    }
    return table[table.length - 1]; // fallback
}

function findLoot() {
    const loot = weightedRandomPick(lootTable);

    // Weapons auto-equip
    if (loot.weapon) {
        equipWeapon(loot.name, loot.damage);
        alert(`You found a ${loot.name}! (Damage: ${loot.damage})`);
        return loot;
    }

    // Everything else
    addToInventory(loot.name, loot.desc, loot.effects || {}, loot.stackable || false);
    return loot;
}

function applyLoot(entry) {
    if (entry.type === "weapon") {
        equipWeapon(entry.name, entry.effects.damage);
    } else {
        addToInventory(entry.name, entry.description);
    }
}

function addToInventory(itemName, description, effects = {}, stackable = false) {
    let existingItem = player.inventory.find(item => item.name === itemName);

    if (existingItem) {
        if (stackable) {
            // âœ… Increment quantity if stackable
            existingItem.quantity = (existingItem.quantity || 1) + 1;
            alert(`You picked up another ${itemName}. You now have x${existingItem.quantity}.`);

            // Apply effects each time food/drink is collected
            if (effects.hp) player.hp += effects.hp;
            if (effects.stamina) player.stamina += effects.stamina;
            enforceLimits();
        } else {
            // âŒ No duplicate if item is unique
            alert(`You already have a ${itemName}.`);
        }
    } else {
        // âœ… Add brand new item
        let newItem = { name: itemName, description: description, ...effects };
        if (stackable) newItem.quantity = 1;

        player.inventory.push(newItem);
        alert(`You have obtained: ${itemName}\n${description}`);

        // Apply effects on first pickup
        if (effects.hp) player.hp += effects.hp;
        if (effects.stamina) player.stamina += effects.stamina;
        if (effects.affinity) player.affinity += effects.affinity;
        enforceLimits();
    }
}

function equipWeapon(weaponName, damage) {
    player.weapon = { name: weaponName, damage: damage };
    alert(`You have equipped: ${weaponName}! It deals ${damage} damage.`);
}


function getValidInput(question, validOptions) {
    let answer;
    do {
        answer = prompt(question + "\n\nfor guide, type: guide").toLowerCase().trim();

        if (answer === "guide") {
            alert(getGuide());
        } else if (answer === "inventory") {
            let weaponStatus = player.weapon && player.weapon.name
                ? `${player.weapon.name} (Damage: ${player.weapon.damage})`
                : "None";

            if (player.inventory.length === 0) {
                alert(`You have no items yet\nWeapon: ${weaponStatus}`);
            } else {
                let itemsList = player.inventory
                    .map(item => `${item.name} - ${item.description}`)
                    .join("\n"); 
                alert(`Your Inventory:\n${itemsList}\n\nWeapon: ${weaponStatus}`);
            }
        }

        if (answer === "quit") {
            break;
        }
        if (answer === "rest") {
            if (player.stamina >= 100) {
                alert("You are well rested");
            } else {
                alert("You took a short rest");
                player.stamina += 2;
                enforceLimits();
            }
        }

        function checkStats() {
            if (player.stamina <= 50) {
                alert("You are tired and need to rest");
            }
            if (player.hp <= 50) {
                alert("You don't feel so good, there might be some blood on ya");
            }
            if (player.hunger <= 50) {
                alert("You are hungry, eat or drink something soon");
            }
        }

    } while (!validOptions.map(opt => opt.toLowerCase()).includes(answer));

    return answer;
}

var player = {
    name: prompt("Enter your name: ").trim(),
    hp: 100,
    stamina: 100,
    affinity: 100,
    hunger: 100,
    weapon: { name: "Fists", damage: 5 },
    inventory: [],
    gold: 100
};

alert(`Welcome ${player.name} to 'Choices Adventure Game'! Make choices, seek out new paths!`); handleStart();

function getAffinityStatus() {
    return player.affinity >= 51 ? "Good" : "Evil";
}
//**player stats

function getGuide() {
    let inventoryItems = player.inventory.map(item => item.name).join(", ") || "None";
    let weaponStatus = player.weapon ? `${player.weapon.name} (Damage: ${player.weapon.damage})` : "None";
    
    return `Player Stats:
    Name: ${player.name}
    HP: ${player.hp}
    Stamina: ${player.stamina}
    Hunger: ${player.hunger}
    Weapon: ${weaponStatus}
    Affinity: ${getAffinityStatus()}
    Inventory: ${inventoryItems}
    Gold: ${player.gold}
    
    type: "inventory" to see inventory.
    type: "quit" to end game.`;

   
}


// function weightedRandomPick(table) {
//     const totalWeight = table.reduce((sum, item) => sum + (item.rarity || 1), 0);
//     let roll = Math.random() * totalWeight;

//     for (let item of table) {
//         roll -= item.rarity || 1;
//         if (roll <= 0) {
//             return item;
//         }
//     }
//     return table[table.length - 1]; // fallback
// }

// function findLoot() {
//     const loot = weightedRandomPick(lootTable);

//     // Weapons auto-equip
//     if (loot.weapon) {
//         equipWeapon(loot.name, loot.damage);
//         alert(`You found a ${loot.name}! (Damage: ${loot.damage})`);
//         return loot;
//     }

//     // Everything else
//     addToInventory(loot.name, loot.desc, loot.effects || {}, loot.stackable || false);
//     return loot;
// }

// function applyLoot(entry) {
//     if (entry.type === "weapon") {
//         equipWeapon(entry.name, entry.effects.damage);
//     } else {
//         addToInventory(entry.name, entry.description);
//     }
// }

// function addToInventory(itemName, description, effects = {}, stackable = false) {
//     let existingItem = player.inventory.find(item => item.name === itemName);

//     if (existingItem) {
//         if (stackable) {
//             // âœ… Increment quantity if stackable
//             existingItem.quantity = (existingItem.quantity || 1) + 1;
//             alert(`You picked up another ${itemName}. You now have x${existingItem.quantity}.`);

//             // Apply effects each time food/drink is collected
//             if (effects.hp) player.hp += effects.hp;
//             if (effects.stamina) player.stamina += effects.stamina;
//             enforceLimits();
//         } else {
//             // âŒ No duplicate if item is unique
//             alert(`You already have a ${itemName}.`);
//         }
//     } else {
//         // âœ… Add brand new item
//         let newItem = { name: itemName, description: description, ...effects };
//         if (stackable) newItem.quantity = 1;

//         player.inventory.push(newItem);
//         alert(`You have obtained: ${itemName}\n${description}`);

//         // Apply effects on first pickup
//         if (effects.hp) player.hp += effects.hp;
//         if (effects.stamina) player.stamina += effects.stamina;
//         if (effects.affinity) player.affinity += effects.affinity;
//         enforceLimits();
//     }
// }

// function equipWeapon(weaponName, damage) {
//     player.weapon = { name: weaponName, damage: damage };
//     alert(`You have equipped: ${weaponName}! It deals ${damage} damage.`);
// }

//** equipWeapon("These Hands", 5);
//** equipWeapon("Iron Sword", 15);

// addToInventory("Chocolate", "OOooOO Piece of candy!")
// addToInventory("Torch", "A dimly lit torch that can help you navigate dark areas.");

function useInventoryItem() {
    let items = player.inventory.map(item => item.name);
    
    if (items.length === 0) {
        alert("You have no usable items!");
        return false;
    }

    let choice = getValidInput(`Choose an item to use: ${items.join(", ")}`, items);

    let item = player.inventory.find(i => i.name === choice);

    if (item) {
        if (item.name === "Health Potion") {
            player.hp += 20;
            alert("You drink a Health Potion and restore 20 HP!");
        } else if (item.name === "Stamina Potion") {
            player.stamina += 20;
            alert("You drink a Stamina Potion and restore 20 Stamina!");
        } else {
            alert(`You can't use the ${item.name} right now.`);
            return false;
        }

        player.inventory = player.inventory.filter(i => i.name !== choice); // Remove used item
        enforceLimits();
        return true;
    }

    return false;
}


function createEnemy(name, hp, attackDamage) {
    return { name, hp, attackDamage };
}


function combat(enemy) {
     alert(`A wild ${enemy.name} appears! Prepare for battle!`);

   while (player.hp > 0 && enemy.hp > 0) {
         let action = getValidInput(
             `The ${enemy.name} stands before you!\nYour HP: ${player.hp} | Stamina: ${player.stamina}\n${enemy.name}'s HP: ${enemy.hp}\n\nChoose an action:\n'attack' - Use your weapon\n'dodge' - Attempt to avoid damage\n'use' - Use an item`,
             ["attack", "dodge", "use"]
         );

         if (action === "attack") {
             if (player.weapon) {
                 let damage = player.weapon.damage;
                 enemy.hp -= damage;
                 player.stamina -= 10;
                 alert(`You strike the ${enemy.name} with your ${player.weapon.name}, dealing ${damage} damage!`);
             } else {
                 enemy.hp -= 5;
                 player.stamina -= 5;
                 alert(`You punch the ${enemy.name}, dealing 5 damage!`);
             }
         } else if (action === "dodge") {
             if (Math.random() > 0.5) {
                 alert(`You successfully dodge the ${enemy.name}'s attack!`);
                 continue; // Skip enemy attack
            } else {
                 alert(`You fail to dodge the attack!`);     }
         } else if (action === "use") {
            if (player.inventory.length > 0) {
                 let itemUsed = useInventoryItem();
                 if (itemUsed) continue; // Skip enemy attack if an item was used
             } else {
                 alert("You have no items to use!");
             }
         }

         if (enemy.hp > 0) {
             player.hp -= enemy.attackDamage;
             alert(`The ${enemy.name} attacks you, dealing ${enemy.attackDamage} damage!`);
         }

         enforceLimits();
         checkDeath();
     }

    if (player.hp > 0) {
        alert(`You defeated the ${enemy.name}!`);
        return true;
    } else {
        alert(`You were slain by the ${enemy.name}... Game Over.`);
        resetGame();
        return false;
    }
}

  //example combat// 
function handleFightGoblin() {
    let goblin = createEnemy("Goblin", 30, 10);
    combat(goblin);
}
  
function handleDarkKnight() {
    let darkKnight = createEnemy("Dark Knight", 50, 15);
    combat(darkKnight);
}

function handleFightDog(){
    let dog = createEnemy("Dog", 10, 5)
    combat(dog);
}

function handleFightWolf(){
    let wolf = createEnemy("Wold", 15, 8);
    combat(wolf);
}



//**death check 
function checkDeath() {
    if (player.hp <= 0) {
        alert("You have died from your injuries. Game Over.");
        resetGame();
    } else if (player.stamina <= 0) {
        alert("You have collapsed from exhaustion. Game Over.");
        resetGame();
    } else if (player.affinity <= 0) {
        alert("A pack of vicious rabbits senses your evil nature and attacks you! Game Over.");
        resetGame();
    } else if (player.hunger <= 0) {
        alert("You have staved to death! Game over!");
        resetGame();
    }
}

function checkRanDeath(){
  const messages = [
  "You trip over your own feet",
  "A hand reaches through the door and squeezes you",
  "The door swings open and hits you",
  "You take a drink of water and start choking",
  "A flock of rabbid squirrles decends apon you.",
  "You are beat to death by the door",
  "You die from an allergic reaction.",
  "Trogdor the buninator swoops down, burning the village and you. TRRROOGGGDDOOORR THE BURNINATOR!!!",
  "A WILD SALAD FINGERS APEARS WITH RUSTY SPOONS!",
  "Wow",
  "Ah yes, the legendary hero of â€˜Nopeâ€™ strikes again!",
  "Remember: retreat is just a tactical nap.",
  "Bold move. Most heroes wait until they're inside to give up.",
  "Turns out bravery is optional. So is progress.",
]; 

const randomMessage = messages[Math.floor(Math.random() * messages.length)];

  if (player.hp <= 0 ){
    alert(randomMessage);
    resetGame();
  }
}

//**reset game on death
function resetGame() {
    alert("Restarting game...");
    player.hp = 100;
    player.stamina = 100;
    player.affinity = 100;
    player.hunger = 100;
    player.gold = 100;
    player.inventory = [];
    
    handleStart(); // Restart the game at the beginning
}

function enforceLimits() {
    player.hp = Math.min(player.hp, 100);
    player.stamina = Math.min(player.stamina, 100);
    player.affinity = Math.min(player.affinity, 100);
    player.hunger = Math.min(player.hunger, 100);
}

function getMerchantItems(count = 3) {
    const pickedItems = [];

    while (pickedItems.length < count) {
        const item = weightedRandomPick(lootTable);

        // Ensure no duplicates
        if (!pickedItems.find(i => i.name === item.name)) {
            pickedItems.push(item);
        }
    }

    return pickedItems;
}

// const merchantItems = getMerchantItems(3);

//         const itemListText = merchantItems.map((item, index) =>
//             `${index + 1}. ${item.name} - ${item.desc || "No description"}`
//         ).join("\n");

//         let choice = getValidInput(
//             `I have a few things in my shop, let's see here:\n\n${itemListText}\n\nWhich item would you like to buy? (1, 2, or 3)`,
//             ["1", "2", "3"]
//         );

//         let selectedItem = merchantItems[parseInt(choice) - 1];

//         if (selectedItem.weapon) {
//             equipWeapon(selectedItem.name, selectedItem.damage);
//         } else {
//             addToInventory(
//                 selectedItem.name,
//                 selectedItem.desc || "No description",
//                 selectedItem.effects || {},
//                 selectedItem.stackable || false
//             );
//         }

//         alert(`You bought: ${selectedItem.name}`);
//         handleVillage(); // continue game

function handleStart(){
    let choice = getValidInput("A door appears infront of you, do you 'enter' or 'leave'",
    ["enter", "leave"] 
    ); 
    if (choice === "enter"){
        handleChoiceOne();
    }else if(choice === "leave"){
      /*randomMessage;*/
      player.hp-=101;
      enforceLimits();
      checkRanDeath();
    }
}

function handleChoiceOne(){
    let choice = getValidInput("Entering through the door a flashing light blinds you, as your vision clears you see open skys, "+ 
    " a far off mountain ranges, and forests lining the forked path infront of you. You can go 'left', 'right' ",["left", "right"]);
    if (choice ==="left"){
        handleLeftOne();
    } else {
        handleRightOne();
    }
}









function handleLeftOne(){
    let choice = getValidInput("You come across a merchant sitting aways up the road, do you 'walk' past them, or 'talk' to the merchant", ["walk","talk"]);
    if (choice === "walk"){
        alert("You walk past the merchant, they stare at you while you walk buy, however they dont say anything to you.");
        player.affinity -= 5;
        enforceLimits();
        checkRanDeath();
        handleLeft1_2();
    } else if (choice === "talk"){
        handleLeft1_3();
    }
    
}

function handleLeft1_2(){
    let choice = getValidInput("As your journey continues, you come across a small village, do you - 'enter' the village, or 'leave' and keep walking.", ["enter", "leave"]);
    if( choice === "leave"){
        handleLeft1_4();
    } else if (choice === "enter"){
        handleVillage();
    }
}

function handleLeft1_3() {
    let choice = getValidInput("The Merchant:\n\n 'Hello! My name is GREG, what can I do for you today?'\n\n 'buy', 'leave' ",["buy","leave"]);
    
    if (choice === "leave") {
        let found = findLoot();
        alert(`You walk for several miles until you find a small town. While walking you found: ${found.name}!`);
        handleVillage();
    } 
    else if (choice === "buy") {
        const merchantItems = getMerchantItems(3);

        const itemListText = merchantItems.map((item, index) =>
            `${index + 1}. ${item.name} - ${item.desc || "No description"}`
        ).join("\n");

        let choice = getValidInput(
            `I have a few things in my shop, let's see here:\n\n${itemListText}\n\nWhich item would you like to buy? (1, 2, or 3)`,
            ["1", "2", "3"]
        );

        let selectedItem = merchantItems[parseInt(choice) - 1];

        if (selectedItem.weapon) {
            equipWeapon(selectedItem.name, selectedItem.damage);
        } else {
            addToInventory(
                selectedItem.name,
                selectedItem.desc || "No description",
                selectedItem.effects || {},
                selectedItem.stackable || false
            );
        }

        alert(`You bought: ${selectedItem.name}`);
        handleVillage(); // continue game
    }
}

function getVillageItems(count) {
    const shuffled = [...lootTable].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
}

let villageSearched = false;

function handleVillage(){
    let choice = getValidInput("You come to a small village, it appears to once have had people living in it, " + 
    "however now it is empty, do you 'stay' the night before moving on, " +
    "'search' the village for items, or 'leave'?", ["stay","search","leave"]
    );

    if (choice === "stay"){
        alert("You are woken abrubtly in the middle of the night by load noises, prepare to fight");
        handleFightGoblin();
        handleVillage();
    } else if (choice === "search"){
        if( villageSearched){
            alert("You've aready searched the village. There's nothing left to find.");
        } else {
            const villageItems = getVillageItems(4);

            let foundItemsText = "you seartch the village and find:\n";

            villageItems.forEach(item => {
                addToInventory(
                    item.name,
                    item.desc || "No description",
                    item.effects || {},
                    item.stackable || false 
                );

                foundItemsText +=`-${item.name}: ${item.desc || "No description"}\n`
            });

            alert(foundItemsText);
            villageSearched = true;

        }
        
    } else if (choice === "leave"){
        alert("Under construction! Come back later!");
    }


}







function handleRightOne(){
    let choice = getValidInput("Traveling down a winding path you come across a steam, you can either 'swim' across, or take the 'bridge'", ["swim","bridge"]);
    if (choice === "swim"){
        alert("You get swept away by the currents, smashing up against rocks, "+ 
        "fallen trees, and the floor of the stream, you are slightly hurt and the experience tires you out. " + 
        "\n\nAs you pull your self from the water, you find a angry wolf infront of you, DRAW SWORDS!");
        player.hp -= 10;
        player.stamina -= 10;
        enforceLimits();
        checkRanDeath();
        handleFightWolf();
        handleRight1_2();
    } else {
        handleRight1_3();
    }
}

function handleRight1_2(){

}

function handleRight1_3(){
    let choice = getValidInput("You cross the bridge, the path is long, as you walk through the"+
    " forest you hear some people talking up ahead, do you 'talk' to them, 'hide' in the trees, 'walk' past them ",
    ["hide","talk","walk"]
    );
        if(choice === "hide"){
            alert("You hide up a tree, for several hours, eventually the people pass,"+
            " its a pregant woman and her husband. as you get down from the tree you fall. You get up and keep going onward.");
            player.hp -= 5;
            enforceLimits();
            checkRanDeath();
            handleRight1_4();
        } else if (choice === "talk"){
            let dogChoice = getValidInput("OHhhHH MY! I appologize, You scared us, we seem to have lost our dog,"+
                " could you help us find him? he looks like a wolf but he has a collar on. \n\n'Yes', 'No'",
                ["Yes","No"]
            );

            if(dogChoice === "yes"){
                alert("You look around for while, and come acorss a dog buy a stream, taking the pup back to the family, they are over joyed and give you a gift!");
                
            } else {
                handleRight1_4();
            }

    } else {
        handleRight1_4();
    }

}



 
</script>